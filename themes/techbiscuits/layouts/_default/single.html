{{ define "main" }}
    {{ partial "breadcrumb.html" . }}

    <section class="post-hero">
        <div class="post-hero__content">
            <p class="eyebrow">Featured Article</p>
            <h1>{{ .Title }}</h1>
            <div class="meta-info">
                <span class="author">By {{ .Params.author | default "Zack Baxter" }}</span>
                <span class="date">Published on {{ .Date.Format "January 2, 2006" }}</span>
                <span class="reading-time">{{ .ReadingTime }} min read</span>
            </div>
            {{ with .Params.tags }}
            <div class="meta-tags">
                {{ range . }}
                <span class="tag-pill">{{ . }}</span>
                {{ end }}
            </div>
            {{ end }}
        </div>
    </section>

    <article class="single-post-article">

        {{ with .TableOfContents }}
        <div class="table-of-contents">
            <h2>Contents</h2>
            {{ . | replaceRE "^<nav[^>]*>" "" | replaceRE "</nav>$" "" | safeHTML }}
        </div>
        {{ end }}

        <section class="content">
            {{ .Content }}
        </section>

        <aside class="related-posts">
            <h3>Related Posts</h3>
            <ul>
                {{ $current := . }}
                {{ $tags := .Params.tags }}
                {{ $all := sort (where .Site.RegularPages "Section" "blog") "Date" "desc" }}
                {{ $related := slice }}

                {{ if $tags }}
                    {{ range $all }}
                        {{ if and (ne .Permalink $current.Permalink) (gt (len (intersect .Params.tags $tags)) 0) }}
                            {{ $related = $related | append . }}
                        {{ end }}
                    {{ end }}
                {{ end }}

                {{ if lt (len $related) 3 }}
                    {{ range $all }}
                        {{ if and (ne .Permalink $current.Permalink) (not (in $related .)) }}
                            {{ $related = $related | append . }}
                        {{ end }}
                        {{ if ge (len $related) 3 }}{{ break }}{{ end }}
                    {{ end }}
                {{ end }}

                {{ range first 3 $related }}
                    <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
                {{ end }}
            </ul>
        </aside>
    </article>
{{ end }}
